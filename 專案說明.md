# Nitroso Tin å°ˆæ¡ˆèªªæ˜

## å°ˆæ¡ˆæ¦‚è¿°

**Nitroso Tin** æ˜¯ä¸€å€‹ç”¨ Go èªè¨€é–‹ç™¼çš„**ç«è»Šç¥¨è‡ªå‹•è¨‚ç¥¨ç³»çµ±**ï¼Œå°ˆé–€ç”¨æ–¼é¦¬ä¾†è¥¿äº KTMB (Keretapi Tanah Melayu Berhad) ç«è»Šç¥¨çš„è‡ªå‹•åŒ–è¨‚è³¼ã€‚

### æ ¸å¿ƒåŠŸèƒ½

é€™å€‹å°ˆæ¡ˆæä¾›äº†ä¸€å€‹å®Œæ•´çš„ç«è»Šç¥¨è‡ªå‹•è¨‚è³¼æµç¨‹ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦åŠŸèƒ½ï¼š

1. **ç›£æ§ç¥¨å‹™è®ŠåŒ–** (CDC - Change Data Capture)
2. **è¼ªè©¢ç¥¨å‹™å¯ç”¨æ€§** (Poller)
3. **è±å¯Œç¥¨å‹™è³‡è¨Š** (Enricher)
4. **é è¨‚è»Šç¥¨** (Reserver)
5. **è³¼è²·è»Šç¥¨** (Buyer)
6. **çµ‚æ­¢å’Œæ¸…ç†** (Terminator)

## ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹æµç¨‹

```
å¤–éƒ¨ç³»çµ± (Zinc API)
  â†“
CDC (ç›£æ§è®ŠåŒ–) â”€â”€â†’ Redis Stream: "cdc"
  â†“
Poller (è¼ªè©¢å¯ç”¨æ€§) â”€â”€â†’ Redis Stream: "update"
  â†“
Enricher (è±å¯Œè³‡è¨Š) â”€â”€â†’ Redis Stream: "enricher"
  â†“
Reserver (é è¨‚) â”€â”€â†’ Redis Stream: "reserver"
  â†“
Buyer (è³¼è²·) â”€â”€â†’ Zinc API (å®Œæˆè¨‚å–®)
  â†“
Terminator (æ¸…ç†)
```

### æ ¸å¿ƒçµ„ä»¶è©³ç´°èªªæ˜

#### 1. **CDC (Change Data Capture)** - `cmds/cdc.go`
- **åŠŸèƒ½**: ç›£æ§å¤–éƒ¨ç³»çµ±ï¼ˆZinc APIï¼‰çš„è®ŠåŒ–ï¼Œå°‡è®ŠåŒ–æ•¸æ“šæ•ç²ä¸¦æ¨é€åˆ° Redis Stream
- **ä½ç½®**: `lib/cdc/`
- **å·¥ä½œåŸç†**:
  - å¾ Zinc API æ‹‰å–è¨‚å–®è®ŠåŒ–æ•¸æ“š
  - å°‡è®ŠåŒ–æ¨é€åˆ° Redis Stream (`cdc` stream)
  - ä½œç‚ºæ•´å€‹æµç¨‹çš„èµ·é»ï¼Œè§¸ç™¼å¾ŒçºŒè™•ç†æµç¨‹
- **ä¾è³´**: Zinc API (`lib/zinc/`)

#### 2. **Poller** - `cmds/poller.go`
- **åŠŸèƒ½**: ä½¿ç”¨ Kubernetes Job è¼ªè©¢ç¥¨å‹™å¯ç”¨æ€§
- **ä½ç½®**: `lib/poller/`
- **å·¥ä½œåŸç†**:
  - ç›£è½ `cdc` stream çš„è®ŠåŒ–
  - å‰µå»º Kubernetes Job ä¾†æª¢æŸ¥ç‰¹å®šè»Šæ¬¡çš„ç¥¨å‹™å¯ç”¨æ€§
  - å°‡å¯ç”¨æ€§ä¿¡æ¯æ¨é€åˆ° `update` stream
- **ä¾è³´**: Kubernetes APIã€KTMB API

#### 3. **Enricher** - `cmds/enricher.go`
- **åŠŸèƒ½**: è±å¯Œç¥¨å‹™æ•¸æ“šï¼Œæ·»åŠ é¡å¤–è³‡è¨Šï¼ˆå¦‚ç”¨æˆ¶æ•¸æ“šã€å•†åº—è³‡è¨Šï¼‰
- **ä½ç½®**: `lib/enricher/`
- **å·¥ä½œåŸç†**:
  - å¾ `update` stream è®€å–ç¥¨å‹™ä¿¡æ¯
  - å¾ Redis Cache ç²å–ç”¨æˆ¶æ•¸æ“šå’Œå•†åº—è³‡è¨Š
  - å°‡è±å¯Œå¾Œçš„æ•¸æ“šæ¨é€åˆ° `enricher` stream
- **ä¾è³´**: Redis Cacheã€KTMB API

#### 4. **Reserver** - `cmds/reserver.go`
- **åŠŸèƒ½**: è™•ç†è»Šç¥¨é è¨‚é‚è¼¯
- **ä½ç½®**: `lib/reserver/`
- **å·¥ä½œåŸç†**:
  - å¾ `enricher` stream è®€å–è±å¯Œå¾Œçš„ç¥¨å‹™æ•¸æ“š
  - èª¿ç”¨ KTMB API åŸ·è¡Œå¯¦éš›çš„é è¨‚æ“ä½œ
  - åŒ…å«ä¸¦ç™¼æ§åˆ¶å’Œé‡è©¦æ©Ÿåˆ¶ï¼ˆæ­£å¸¸æ¨¡å¼ 25 ä¸¦ç™¼ï¼Œç¶­è­·æ¨¡å¼ 15 ä¸¦ç™¼ï¼‰
  - å°‡é è¨‚çµæœï¼ˆåŠ å¯†å¾Œï¼‰æ¨é€åˆ° `reserver` stream
- **ä¾è³´**: KTMB APIã€Redis Cache

#### 5. **Buyer** - `cmds/buyer.go`
- **åŠŸèƒ½**: åŸ·è¡Œå¯¦éš›çš„è³¼ç¥¨æ“ä½œ
- **ä½ç½®**: `lib/buyer/`
- **å·¥ä½œåŸç†**:
  - å¾ `reserver` stream è®€å–é è¨‚æˆåŠŸçš„æ•¸æ“š
  - èª¿ç”¨ KTMB API å®Œæˆè³¼ç¥¨æµç¨‹
  - ä¸‹è¼‰ç¥¨æ“šæ–‡ä»¶ï¼ˆPDFï¼‰
  - é€šé Zinc API ä¸Šå‚³ç¥¨æ“šä¸¦å®Œæˆè¨‚å–® (`PostApiVVersionBookingCompleteId`)
- **ä¾è³´**: KTMB APIã€Zinc API (`lib/zinc/`)

#### 6. **Terminator** - `cmds/terminator.go`
- **åŠŸèƒ½**: çµ‚æ­¢å’Œæ¸…ç†æµç¨‹
- **ä½ç½®**: `lib/terminator/`
- **å·¥ä½œåŸç†**:
  - ç›£è½çµ‚æ­¢è«‹æ±‚
  - æ¸…ç†ç›¸é—œè³‡æºå’Œé€²ç¨‹
  - ç¢ºä¿ç³»çµ±è³‡æºæ­£ç¢ºé‡‹æ”¾

### Nitroso.Zinc èˆ‡ Nitroso.Tin çš„é—œä¿‚

**Nitroso.Zinc** æ˜¯ä¸€å€‹ç¨ç«‹çš„ API æœå‹™ï¼Œæä¾›è¨‚å–®ç®¡ç†å’Œæ•¸æ“šå­˜å„²åŠŸèƒ½ã€‚**Nitroso.Tin** æ˜¯åŸ·è¡Œå±¤ï¼Œè² è²¬å¯¦éš›çš„è¨‚ç¥¨æ“ä½œã€‚

#### é—œä¿‚æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nitroso.Zinc   â”‚  â† API æœå‹™ï¼ˆè¨‚å–®ç®¡ç†ã€æ•¸æ“šå­˜å„²ï¼‰
â”‚   (å¾Œç«¯æœå‹™)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP API èª¿ç”¨
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nitroso.Tin    â”‚  â† åŸ·è¡Œæœå‹™ï¼ˆè‡ªå‹•è¨‚ç¥¨ï¼‰
â”‚   (åŸ·è¡Œå±¤)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ KTMB API èª¿ç”¨
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KTMB API      â”‚  â† é¦¬ä¾†è¥¿äºç«è»Šç¥¨ç³»çµ±
â”‚  (å¤–éƒ¨ç³»çµ±)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Zinc åœ¨ Tin ä¸­çš„ä½¿ç”¨å ´æ™¯

1. **CDC çµ„ä»¶**: 
   - å¾ Zinc API æ‹‰å–è¨‚å–®è®ŠåŒ–ï¼ˆ`GetApiVVersionBooking*` ç­‰ APIï¼‰
   - ç›£è½æ–°è¨‚å–®æˆ–è¨‚å–®ç‹€æ…‹è®ŠåŒ–

2. **Buyer çµ„ä»¶**:
   - å¾ Zinc API ç²å–é è¨‚ä¿¡æ¯ï¼ˆ`GetApiVVersionBookingReserveDirectionDateTime`ï¼‰
   - å®Œæˆè³¼ç¥¨å¾Œï¼Œä¸Šå‚³ç¥¨æ“šæ–‡ä»¶åˆ° Zinc APIï¼ˆ`PostApiVVersionBookingCompleteId`ï¼‰

3. **æ•¸æ“šåŒæ­¥**:
   - Zinc å­˜å„²è¨‚å–®æ•¸æ“šã€ç”¨æˆ¶ä¿¡æ¯ã€å•†åº—ä¿¡æ¯
   - Tin å¾ Zinc ç²å–é€™äº›æ•¸æ“šä¾†åŸ·è¡Œè¨‚ç¥¨æ“ä½œ

### æŠ€è¡“æ¶æ§‹

#### æ•¸æ“šæµ
- **Redis Streams**: ç”¨æ–¼çµ„ä»¶é–“çš„ç•°æ­¥æ¶ˆæ¯å‚³é
  - `cdc` stream: CDC çµ„ä»¶æ¨é€è®ŠåŒ–æ•¸æ“š
  - `update` stream: Poller æ¨é€å¯ç”¨æ€§æ›´æ–°
  - `enricher` stream: Enricher æ¨é€è±å¯Œå¾Œçš„æ•¸æ“š
  - `reserver` stream: Reserver æ¨é€é è¨‚çµæœ
- **Redis Cache**: ç”¨æ–¼æ•¸æ“šç·©å­˜å’Œç‹€æ…‹ç®¡ç†
  - `MAIN`: ä¸»ç·©å­˜ï¼ˆé€£æ¥ Zinc çš„ Redisï¼‰
  - `LIVE`: å¯¦æ™‚ç·©å­˜
  - `STREAM`: Stream å°ˆç”¨ç·©å­˜
- **Kubernetes Jobs**: ç”¨æ–¼ Poller çš„ä»»å‹™èª¿åº¦

#### å¤–éƒ¨ä¾è³´
- **KTMB API**: é¦¬ä¾†è¥¿äºç«è»Šç¥¨ç³»çµ±çš„ API (`lib/ktmb/`)
  - ç”¨æ–¼æŸ¥è©¢è»Šæ¬¡ã€é è¨‚è»Šç¥¨ã€è³¼è²·è»Šç¥¨
- **Zinc API**: å…§éƒ¨ API æœå‹™ (`lib/zinc/`)
  - ç”¨æ–¼è¨‚å–®ç®¡ç†ã€æ•¸æ“šæŸ¥è©¢ã€ç¥¨æ“šä¸Šå‚³
  - é€šé OpenAPI ç”Ÿæˆçš„å®¢æˆ¶ç«¯ (`lib/zinc/main.go`)
- **Descope**: ç”¨æ–¼èº«ä»½é©—è­‰ (`lib/auth/`)
  - M2M (Machine-to-Machine) èªè­‰
  - ç”¨æ–¼èª¿ç”¨ Zinc API æ™‚çš„èªè­‰

#### å¯è§€æ¸¬æ€§
- **OpenTelemetry**: å®Œæ•´çš„é™æ¸¬ç³»çµ±ï¼ˆæŒ‡æ¨™ã€è¿½è¹¤ã€æ—¥èªŒï¼‰
- **Zerolog**: çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„

## å°ˆæ¡ˆçµæ§‹

```
nitroso.tin-main/
â”œâ”€â”€ main.go                 # æ‡‰ç”¨ç¨‹å¼å…¥å£é»
â”œâ”€â”€ cmds/                    # CLI å‘½ä»¤å¯¦ç¾
â”‚   â”œâ”€â”€ cdc.go
â”‚   â”œâ”€â”€ poller.go
â”‚   â”œâ”€â”€ enricher.go
â”‚   â”œâ”€â”€ reserver.go
â”‚   â”œâ”€â”€ buyer.go
â”‚   â”œâ”€â”€ terminator.go
â”‚   â””â”€â”€ state.go            # å…±äº«ç‹€æ…‹
â”œâ”€â”€ lib/                     # æ ¸å¿ƒæ¥­å‹™é‚è¼¯åº«
â”‚   â”œâ”€â”€ auth/               # èº«ä»½é©—è­‰
â”‚   â”œâ”€â”€ buyer/              # è³¼ç¥¨é‚è¼¯
â”‚   â”œâ”€â”€ cdc/                # è®ŠåŒ–æ•¸æ“šæ•ç²
â”‚   â”œâ”€â”€ enricher/           # æ•¸æ“šè±å¯ŒåŒ–
â”‚   â”œâ”€â”€ ktmb/               # KTMB API å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ poller/             # è¼ªè©¢é‚è¼¯
â”‚   â”œâ”€â”€ reserver/           # é è¨‚é‚è¼¯
â”‚   â”œâ”€â”€ terminator/         # çµ‚æ­¢é‚è¼¯
â”‚   â”œâ”€â”€ encryptor/          # åŠ å¯†å·¥å…·
â”‚   â”œâ”€â”€ otelredis/          # Redis é›†æˆ
â”‚   â””â”€â”€ zinc/               # Zinc API å®¢æˆ¶ç«¯
â”œâ”€â”€ system/                  # ç³»çµ±ç´šåŠŸèƒ½
â”‚   â”œâ”€â”€ config/             # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ telemetry/          # å¯è§€æ¸¬æ€§
â”œâ”€â”€ config/                  # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ settings.yaml           # åŸºç¤é…ç½®
â”‚       â”œâ”€â”€ settings.lapras.yaml    # ç’°å¢ƒç‰¹å®šé…ç½®
â”‚       â”œâ”€â”€ settings.pichu.yaml
â”‚       â”œâ”€â”€ settings.pikachu.yaml
â”‚       â””â”€â”€ settings.raichu.yaml
â”œâ”€â”€ infra/                   # åŸºç¤è¨­æ–½é…ç½®
â”‚   â”œâ”€â”€ Dockerfile          # Docker æ§‹å»ºæ–‡ä»¶
â”‚   â””â”€â”€ consumer_chart/     # Kubernetes Helm Chart
â””â”€â”€ scripts/                 # å·¥å…·è…³æœ¬
```

## å¦‚ä½•åœ¨å€‹äººå°ˆæ¡ˆä¸­ä½¿ç”¨

### ç†è§£é …ç›®ä¾è³´é—œä¿‚

åœ¨ä½¿ç”¨é€™å€‹é …ç›®ä¹‹å‰ï¼Œä½ éœ€è¦ç†è§£ï¼š

1. **Nitroso.Zinc å¿…é ˆå…ˆé‹è¡Œ**: Tin ä¾è³´ Zinc API æœå‹™ï¼Œéœ€è¦ç¢ºä¿ Zinc æœå‹™å¯ç”¨
2. **Redis å¿…é ˆé…ç½®**: é …ç›®ä½¿ç”¨å¤šå€‹ Redis å¯¦ä¾‹ï¼ˆMAINã€LIVEã€STREAMï¼‰
3. **KTMB API è¨ªå•**: éœ€è¦èƒ½å¤ è¨ªå•é¦¬ä¾†è¥¿äº KTMB ç«è»Šç¥¨ç³»çµ±çš„ API

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å–®

#### 1. **é…ç½®æ–‡ä»¶** (å¿…é ˆä¿®æ”¹) âš ï¸

##### `config/app/settings.yaml`
é€™æ˜¯ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼Œ**å¿…é ˆ**æ ¹æ“šä½ çš„ç’°å¢ƒä¿®æ”¹ï¼š

```yaml
# Redis é…ç½® - å¿…é ˆä¿®æ”¹
cache:
  MAIN:
    password: ''              # Redis å¯†ç¢¼ï¼ˆå¦‚æœæœ‰ï¼‰
    ssl: false                # æ˜¯å¦ä½¿ç”¨ SSL
    endpoints:
      0: 'zinc-maincache:6379'  # âš ï¸ ä¿®æ”¹ç‚ºä½ çš„ Redis åœ°å€
  LIVE:
    password: ''
    ssl: false
    endpoints:
      0: 'tin-livecache-master:6379'  # âš ï¸ ä¿®æ”¹ç‚ºä½ çš„å¯¦æ™‚ç·©å­˜åœ°å€
  STREAM:
    password: ''
    ssl: false
    endpoints:
      0: 'zinc-streamcache-master:6379'  # âš ï¸ ä¿®æ”¹ç‚ºä½ çš„ Stream ç·©å­˜åœ°å€
  
# KTMB API é…ç½® - ç¢ºèª API åœ°å€
ktmb:
  apiUrl: https://online-api.ktmb.com.my
  appUrl: https://shuttleonline-api.ktmb.com.my
  requestSignature: ''        # API ç°½åï¼ˆå¦‚æœéœ€è¦ï¼‰
  proxy: ''                    # ä»£ç†è¨­ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  loginKey: 'login-session'

# Buyer é…ç½® - å¿…é ˆä¿®æ”¹
buyer:
  backoffLimit: 3              # é‡è©¦æ¬¡æ•¸
  contactNumber: '+6581272251'  # âš ï¸ ä¿®æ”¹ç‚ºä½ çš„è¯ç¹«é›»è©±
  sleepBuffer: 3               # ç¡çœ ç·©è¡æ™‚é–“ï¼ˆç§’ï¼‰
  scheme: http                 # âš ï¸ Zinc API å”è­°
  host: localhost              # âš ï¸ Zinc API ä¸»æ©Ÿåœ°å€
  port: '9000'                 # âš ï¸ Zinc API ç«¯å£

# CDC é…ç½® - å¿…é ˆä¿®æ”¹ï¼ˆå¦‚æœä½¿ç”¨ CDCï¼‰
cdc:
  scheme: http                 # âš ï¸ Zinc API å”è­°
  host: localhost              # âš ï¸ Zinc API ä¸»æ©Ÿåœ°å€
  port: 9000                   # âš ï¸ Zinc API ç«¯å£
  parallelism: 8               # ä¸¦è¡Œåº¦
  backoffLimit: 3              # é‡è©¦æ¬¡æ•¸

# Enricher é…ç½® - å¿…é ˆä¿®æ”¹
enricher:
  email: kirinnee97@gmail.com  # âš ï¸ ä¿®æ”¹ç‚ºä½ çš„éƒµç®±
  password: ''                  # âš ï¸ è¨­ç½®ä½ çš„å¯†ç¢¼
  userDataKey: ktmb:userData   # Redis éµå
  storeKey: ktmb:store         # Redis éµå

# åŠ å¯†å¯†é‘° - å¿…é ˆè¨­ç½®
encryptor:
  key: ''  # âš ï¸ å¿…é ˆè¨­ç½®åŠ å¯†å¯†é‘°ï¼ˆé€šéç’°å¢ƒè®Šé‡ ENCRYPTION_KEYï¼‰

# æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥ - å¯é¸ä¿®æ”¹
app:
  platform: nitroso  # å¯ä¿®æ”¹ç‚ºä½ çš„å¹³å°åç¨±
  service: tin       # å¯ä¿®æ”¹ç‚ºä½ çš„æœå‹™åç¨±
  module: cdc        # ç•¶å‰æ¨¡çµ„åç¨±
  version: 1.0.0

# Stream é…ç½® - é€šå¸¸ä¸éœ€è¦ä¿®æ”¹
stream:
  cdc: cdc
  update: update
  enrich: enricher
  reserver: reserver
```

##### `config/app/settings.{landscape}.yaml`
æ ¹æ“šä½ çš„ç’°å¢ƒï¼ˆlapras, pichu, pikachu, raichuï¼‰ä¿®æ”¹å°æ‡‰çš„é…ç½®æ–‡ä»¶ï¼Œæˆ–å‰µå»ºæ–°çš„ç’°å¢ƒé…ç½®ã€‚é€™äº›æ–‡ä»¶æœƒè¦†è“‹ `settings.yaml` ä¸­çš„é…ç½®ã€‚

#### 2. **èº«ä»½é©—è­‰é…ç½®** (å¿…é ˆä¿®æ”¹) âš ï¸

##### `config/app/settings.yaml` ä¸­çš„ `auth` éƒ¨åˆ†
éœ€è¦é…ç½® Descope èªè­‰ä¿¡æ¯ï¼ˆç”¨æ–¼èª¿ç”¨ Zinc APIï¼‰ï¼š
```yaml
auth:
  descope:
    descopeId: ''        # âš ï¸ ä½ çš„ Descope ID
    descopeAccessKey: '' # âš ï¸ ä½ çš„ Descope Access Key
```

**æ³¨æ„**: å¦‚æœæ²’æœ‰ `auth` é…ç½®ï¼Œé …ç›®æœƒå•Ÿå‹•å¤±æ•—ã€‚ä½ éœ€è¦ï¼š
- è¨»å†Š Descope æœå‹™ä¸¦ç²å–æ†‘è­‰ï¼Œæˆ–
- ä¿®æ”¹ `lib/auth/credentials_provider.go` ä½¿ç”¨å…¶ä»–èªè­‰æ–¹å¼

#### 3. **ç’°å¢ƒè®Šé‡é…ç½®** (å¿…é ˆè¨­ç½®) âš ï¸

å‰µå»ºæˆ–ä¿®æ”¹ `.envrc` æˆ–è¨­ç½®ç’°å¢ƒè®Šé‡ï¼š
```bash
# å¿…é ˆè¨­ç½®
export LANDSCAPE=lapras          # é¸æ“‡ç’°å¢ƒï¼ˆlapras/pichu/pikachu/raichuï¼‰
export BASE_CONFIG=./config/app  # é…ç½®è·¯å¾‘
export ENCRYPTION_KEY=your-key   # âš ï¸ åŠ å¯†å¯†é‘°ï¼ˆå¿…é ˆè¨­ç½®ï¼Œç”¨æ–¼åŠ å¯†æ•æ„Ÿæ•¸æ“šï¼‰
```

#### 4. **Zinc API é…ç½®** (å¿…é ˆç¢ºèª) âš ï¸

**é‡è¦**: Nitroso.Tin ä¾è³´ Nitroso.Zinc API æœå‹™ã€‚ä½ éœ€è¦ï¼š

1. **ç¢ºä¿ Zinc æœå‹™é‹è¡Œ**: 
   - Zinc æœå‹™å¿…é ˆåœ¨ `buyer.host:buyer.port` å’Œ `cdc.host:cdc.port` é…ç½®çš„åœ°å€ä¸Šé‹è¡Œ
   - é»˜èªæ˜¯ `localhost:9000`

2. **ç¢ºèª Zinc API ç«¯é»**:
   - Buyer çµ„ä»¶æœƒèª¿ç”¨: `GET /api/v{version}/booking/reserve/{direction}/{date}/{time}`
   - Buyer çµ„ä»¶æœƒèª¿ç”¨: `POST /api/v{version}/booking/complete/{id}` (ä¸Šå‚³ç¥¨æ“š)
   - CDC çµ„ä»¶æœƒèª¿ç”¨: `GET /api/v{version}/booking/*` (æŸ¥è©¢è¨‚å–®)

3. **å¦‚æœ Zinc API æœ‰è®ŠåŒ–**:
   - é‡æ–°ç”Ÿæˆ SDK: `task sdk:gen`
   - æˆ–æ‰‹å‹•ä¿®æ”¹ `lib/zinc/main.go`ï¼ˆé€™æ˜¯è‡ªå‹•ç”Ÿæˆçš„ OpenAPI å®¢æˆ¶ç«¯ï¼‰

#### 5. **KTMB API é›†æˆ** (å¯èƒ½éœ€è¦ä¿®æ”¹)

##### `lib/ktmb/`
å¦‚æœ KTMB API æœ‰è®ŠåŒ–ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ï¼š
- `lib/ktmb/ktmb.go` - API å®¢æˆ¶ç«¯å¯¦ç¾
- `lib/ktmb/req.go` - è«‹æ±‚çµæ§‹
- `lib/ktmb/res.go` - éŸ¿æ‡‰çµæ§‹
- `lib/ktmb/http.go` - HTTP å®¢æˆ¶ç«¯é…ç½®

**æ³¨æ„**: å¦‚æœ KTMB API éœ€è¦ç‰¹å®šçš„èªè­‰ã€ç°½åæˆ–ä»£ç†è¨­ç½®ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¨­ç½®ã€‚

#### 6. **æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥** (å¯é¸ä¿®æ”¹)

##### `main.go`
ä¿®æ”¹æ‡‰ç”¨ç¨‹å¼åç¨±å’Œæ¨¡çµ„è­˜åˆ¥ï¼š
```go
psm := fmt.Sprintf("%s.%s.%s", cfgApp.Platform, cfgApp.Service, cfgApp.Module)
```

##### `go.mod`
ä¿®æ”¹æ¨¡çµ„åç¨±ï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰ï¼š
```go
module github.com/AtomiCloud/nitroso-tin
// æ”¹ç‚ºä½ çš„æ¨¡çµ„è·¯å¾‘
```

#### 7. **åŸºç¤è¨­æ–½é…ç½®** (å¦‚æœéƒ¨ç½²åˆ° Kubernetes)

##### `infra/consumer_chart/`
- `values.yaml` - Helm Chart å€¼
- `templates/` - Kubernetes æ¨¡æ¿

##### `infra/root_chart/`
- `values.yaml` - æ ¹ Chart é…ç½®

### å¿«é€Ÿé–‹å§‹æ­¥é©Ÿ

1. **å…‹éš†ä¸¦è¨­ç½®ç’°å¢ƒ**
   ```bash
   # è¨­ç½®ç’°å¢ƒè®Šé‡
   export LANDSCAPE=lapras
   export BASE_CONFIG=./config/app
   export ENCRYPTION_KEY=your-encryption-key
   ```

2. **ä¿®æ”¹é…ç½®æ–‡ä»¶**
   - ç·¨è¼¯ `config/app/settings.yaml`
   - è¨­ç½® Redis é€£æ¥ä¿¡æ¯
   - è¨­ç½® KTMB API é…ç½®
   - è¨­ç½®èº«ä»½é©—è­‰ä¿¡æ¯

3. **å®‰è£ä¾è³´**
   ```bash
   go mod download
   ```

4. **æ§‹å»ºæ‡‰ç”¨**
   ```bash
   task build
   # æˆ–
   go build -o bin/nitroso-tin .
   ```

5. **é‹è¡Œç‰¹å®šçµ„ä»¶**
   ```bash
   # é‹è¡Œ CDC
   ./bin/nitroso-tin cdc
   
   # é‹è¡Œ Poller
   ./bin/nitroso-tin poller
   
   # é‹è¡Œ Enricher
   ./bin/nitroso-tin enricher
   
   # é‹è¡Œ Reserver
   ./bin/nitroso-tin reserver
   
   # é‹è¡Œ Buyer
   ./bin/nitroso-tin buyer
   
   # é‹è¡Œ Terminator
   ./bin/nitroso-tin terminator
   ```

### é–‹ç™¼æ¨¡å¼

ä½¿ç”¨ Task å·¥å…·é‹è¡Œï¼ˆæ¨è–¦ï¼‰ï¼š
```bash
# è¨­ç½®ç’°å¢ƒ
task setup

# é–‹ç™¼æ¨¡å¼é‹è¡Œ
task dev -- cdc

# ç›£è¦–æ¨¡å¼ï¼ˆè‡ªå‹•é‡è¼‰ï¼‰
task dev:watch -- cdc
```

## é‡è¦æ³¨æ„äº‹é …

1. **åŠ å¯†å¯†é‘°**: å¿…é ˆè¨­ç½® `ENCRYPTION_KEY` ç’°å¢ƒè®Šé‡ï¼Œç”¨æ–¼åŠ å¯†æ•æ„Ÿæ•¸æ“š
2. **Redis é€£æ¥**: ç¢ºä¿ Redis æœå‹™å¯ç”¨ï¼Œä¸¦ä¸”é…ç½®æ­£ç¢º
3. **KTMB API**: ç¢ºèª API ç«¯é»å’Œèªè­‰æ–¹å¼æ˜¯å¦æ­£ç¢º
4. **èº«ä»½é©—è­‰**: å¦‚æœä½¿ç”¨ Descopeï¼Œéœ€è¦æ­£ç¢ºé…ç½®èªè­‰ä¿¡æ¯
5. **ç’°å¢ƒé…ç½®**: æ ¹æ“šä½ çš„éƒ¨ç½²ç’°å¢ƒé¸æ“‡æ­£ç¢ºçš„ landscape é…ç½®

## ç¸½çµ

### é …ç›®åŠŸèƒ½ç¸½çµ

**Nitroso.Tin** æ˜¯ä¸€å€‹å®Œæ•´çš„ç«è»Šç¥¨è‡ªå‹•è¨‚è³¼ç³»çµ±ï¼Œæ¡ç”¨å¾®æœå‹™æ¶æ§‹ï¼Œä½¿ç”¨ Redis Streams é€²è¡Œçµ„ä»¶é–“ç•°æ­¥é€šä¿¡ã€‚å®ƒèˆ‡ **Nitroso.Zinc**ï¼ˆè¨‚å–®ç®¡ç† API æœå‹™ï¼‰å”åŒå·¥ä½œï¼Œå¯¦ç¾å¾è¨‚å–®ç›£æ§åˆ°è‡ªå‹•è³¼ç¥¨çš„å®Œæ•´æµç¨‹ã€‚

### æ ¸å¿ƒåƒ¹å€¼

1. **è‡ªå‹•åŒ–æµç¨‹**: å¾ç›£æ§è¨‚å–®è®ŠåŒ–åˆ°å®Œæˆè³¼ç¥¨ï¼Œå…¨ç¨‹è‡ªå‹•åŒ–
2. **é«˜å¯é æ€§**: åŒ…å«é‡è©¦æ©Ÿåˆ¶ã€ä¸¦ç™¼æ§åˆ¶ã€éŒ¯èª¤è™•ç†
3. **å¯æ“´å±•æ€§**: åŸºæ–¼ Redis Streams çš„ç•°æ­¥æ¶æ§‹ï¼Œæ˜“æ–¼æ“´å±•
4. **å¯è§€æ¸¬æ€§**: å®Œæ•´çš„ OpenTelemetry é›†æˆï¼Œä¾¿æ–¼ç›£æ§å’Œèª¿è©¦

### åœ¨å€‹äººé …ç›®ä¸­ä½¿ç”¨ - å¿«é€Ÿæª¢æŸ¥æ¸…å–®

#### âœ… å¿…é ˆå®Œæˆçš„é…ç½®ï¼ˆæŒ‰é †åºï¼‰

1. **ç’°å¢ƒè®Šé‡** âš ï¸
   - [ ] è¨­ç½® `ENCRYPTION_KEY`
   - [ ] è¨­ç½® `LANDSCAPE`
   - [ ] è¨­ç½® `BASE_CONFIG`

2. **Redis é…ç½®** âš ï¸
   - [ ] é…ç½® `cache.MAIN.endpoints`ï¼ˆé€£æ¥ Zinc çš„ Redisï¼‰
   - [ ] é…ç½® `cache.LIVE.endpoints`ï¼ˆå¯¦æ™‚ç·©å­˜ï¼‰
   - [ ] é…ç½® `cache.STREAM.endpoints`ï¼ˆStream ç·©å­˜ï¼‰
   - [ ] ç¢ºä¿æ‰€æœ‰ Redis å¯¦ä¾‹å¯è¨ªå•

3. **Zinc API é…ç½®** âš ï¸
   - [ ] ç¢ºä¿ Nitroso.Zinc æœå‹™é‹è¡Œ
   - [ ] é…ç½® `buyer.host` å’Œ `buyer.port`ï¼ˆZinc API åœ°å€ï¼‰
   - [ ] é…ç½® `cdc.host` å’Œ `cdc.port`ï¼ˆå¦‚æœä½¿ç”¨ CDCï¼‰
   - [ ] é…ç½® `auth.descope`ï¼ˆç”¨æ–¼èª¿ç”¨ Zinc APIï¼‰

4. **KTMB API é…ç½®**
   - [ ] ç¢ºèª `ktmb.apiUrl` å’Œ `ktmb.appUrl` æ­£ç¢º
   - [ ] è¨­ç½® `ktmb.requestSignature`ï¼ˆå¦‚æœéœ€è¦ï¼‰
   - [ ] è¨­ç½® `ktmb.proxy`ï¼ˆå¦‚æœéœ€è¦ä»£ç†ï¼‰

5. **æ¥­å‹™é…ç½®**
   - [ ] è¨­ç½® `buyer.contactNumber`ï¼ˆä½ çš„è¯ç¹«é›»è©±ï¼‰
   - [ ] è¨­ç½® `enricher.email` å’Œ `enricher.password`ï¼ˆKTMB è³¬è™Ÿï¼‰

#### ğŸ“ å¯èƒ½éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **é…ç½®æ–‡ä»¶** (å¿…é ˆ)
   - `config/app/settings.yaml` - ä¸»é…ç½®æ–‡ä»¶
   - `config/app/settings.{landscape}.yaml` - ç’°å¢ƒç‰¹å®šé…ç½®

2. **API é›†æˆ** (å¦‚æœ API æœ‰è®ŠåŒ–)
   - `lib/ktmb/` - KTMB API å®¢æˆ¶ç«¯
   - `lib/zinc/main.go` - Zinc API å®¢æˆ¶ç«¯ï¼ˆé€šé `task sdk:gen` é‡æ–°ç”Ÿæˆï¼‰

3. **æ‡‰ç”¨è­˜åˆ¥** (å¯é¸)
   - `main.go` - ä¿®æ”¹æ‡‰ç”¨åç¨±
   - `go.mod` - ä¿®æ”¹æ¨¡çµ„è·¯å¾‘

#### ğŸš€ å»ºè­°çš„å¯¦æ–½æ­¥é©Ÿ

1. **æº–å‚™éšæ®µ**
   ```bash
   # 1. è¨­ç½®ç’°å¢ƒè®Šé‡
   export ENCRYPTION_KEY=your-key
   export LANDSCAPE=lapras
   export BASE_CONFIG=./config/app
   
   # 2. ç¢ºä¿ä¾è³´æœå‹™é‹è¡Œ
   # - Nitroso.Zinc API æœå‹™
   # - Redis (MAIN, LIVE, STREAM)
   ```

2. **é…ç½®éšæ®µ**
   - ç·¨è¼¯ `config/app/settings.yaml`
   - ä¿®æ”¹æ‰€æœ‰æ¨™è¨˜ç‚º âš ï¸ çš„é…ç½®é …
   - æ ¹æ“šç’°å¢ƒå‰µå»ºæˆ–ä¿®æ”¹ `settings.{landscape}.yaml`

3. **æ¸¬è©¦éšæ®µ**
   ```bash
   # æ§‹å»ºé …ç›®
   task build
   
   # æ¸¬è©¦å–®å€‹çµ„ä»¶ï¼ˆæŒ‰é †åºï¼‰
   ./bin/nitroso-tin cdc        # æ¸¬è©¦ CDC
   ./bin/nitroso-tin poller     # æ¸¬è©¦ Poller
   ./bin/nitroso-tin enricher   # æ¸¬è©¦ Enricher
   ./bin/nitroso-tin reserver   # æ¸¬è©¦ Reserver
   ./bin/nitroso-tin buyer      # æ¸¬è©¦ Buyer
   ```

4. **éƒ¨ç½²éšæ®µ**
   - å¦‚æœä½¿ç”¨ Kubernetesï¼Œé…ç½® `infra/root_chart/`
   - ç¢ºä¿æ‰€æœ‰ç’°å¢ƒè®Šé‡å’Œé…ç½®æ­£ç¢º

### å¸¸è¦‹å•é¡Œ

**Q: å¦‚æœæ²’æœ‰ Nitroso.Zinc æœå‹™æ€éº¼è¾¦ï¼Ÿ**  
A: ä½ éœ€è¦å…ˆéƒ¨ç½² Nitroso.Zinc æœå‹™ï¼Œæˆ–è€…ä¿®æ”¹ä»£ç¢¼ä½¿ç”¨å…¶ä»–è¨‚å–®ç®¡ç†ç³»çµ±ã€‚

**Q: å¯ä»¥åªç”¨éƒ¨åˆ†çµ„ä»¶å—ï¼Ÿ**  
A: å¯ä»¥ï¼Œä½†éœ€è¦ç†è§£çµ„ä»¶é–“çš„ä¾è³´é—œä¿‚ã€‚ä¾‹å¦‚ï¼ŒBuyer ä¾è³´ Reserver çš„è¼¸å‡ºã€‚

**Q: å¦‚ä½•è‡ªå®šç¾©è¨‚ç¥¨é‚è¼¯ï¼Ÿ**  
A: ä¸»è¦ä¿®æ”¹ `lib/reserver/` å’Œ `lib/buyer/` ä¸­çš„æ¥­å‹™é‚è¼¯ã€‚

**Q: å¦‚ä½•èª¿è©¦ï¼Ÿ**  
A: ä½¿ç”¨ `task dev:watch` é€²è¡Œé–‹ç™¼ï¼ŒæŸ¥çœ‹ OpenTelemetry æ—¥èªŒå’Œè¿½è¹¤ã€‚

### æ¶æ§‹åœ–ç¸½çµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zinc API   â”‚ â† è¨‚å–®ç®¡ç†ã€æ•¸æ“šå­˜å„²
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ CDC â”€â”€â†’ Redis Stream â”€â”€â†’ Poller â”€â”€â†’ Enricher â”€â”€â†’ Reserver â”€â”€â†’ Buyer â”€â”€â†’ Zinc API
       â”‚                                                                              (ä¸Šå‚³ç¥¨æ“š)
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å»ºè­°å…ˆå¾é…ç½®æ–‡ä»¶é–‹å§‹ï¼Œé€æ­¥æ¸¬è©¦æ¯å€‹çµ„ä»¶ï¼Œç¢ºä¿æ‰€æœ‰ä¾è³´æœå‹™ï¼ˆRedisã€Zinc APIã€KTMB APIï¼‰éƒ½æ­£å¸¸é‹ä½œã€‚