# Nitroso.Tin 架構理解指南

## 一、項目是什麼？

**Nitroso.Tin** 是一個**火車票自動訂票執行系統**，它會：
1. 監聽訂單變化
2. 自動檢查車票可用性
3. 自動預訂和購買車票
4. 上傳票據到訂單系統

## 二、核心概念

### 2.1 兩個服務的關係

```
┌─────────────────────────────────────────────────────────┐
│                    Nitroso 平台                            │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐              ┌──────────────┐         │
│  │ Nitroso.Zinc │              │ Nitroso.Tin │         │
│  │              │              │             │         │
│  │ 訂單管理 API  │◄─────────────┤ 自動訂票執行 │         │
│  │ 數據存儲      │   HTTP API   │ 業務邏輯    │         │
│  │ 用戶管理      │              │             │         │
│  └──────────────┘              └──────┬───────┘         │
│                                       │                 │
│                                       │ KTMB API        │
│                                       ▼                 │
│                              ┌──────────────┐          │
│                              │   KTMB API   │          │
│                              │ (火車票系統)  │          │
│                              └──────────────┘          │
└─────────────────────────────────────────────────────────┘
```

**簡單理解**：
- **Zinc** = 大腦（管理訂單、存儲數據）
- **Tin** = 手腳（執行實際的訂票操作）

### 2.2 六個組件的流程

```
用戶在 Zinc 創建訂單
    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. CDC (Change Data Capture)                            │
│    監聽 Zinc API 的訂單變化                              │
│    發現新訂單 → 推送到 Redis Stream "cdc"              │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 2. Poller (輪詢器)                                       │
│    從 "cdc" stream 讀取訂單                              │
│    創建 Kubernetes Job 檢查車票可用性                     │
│    發現可用車票 → 推送到 Redis Stream "update"           │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. Enricher (數據豐富器)                                 │
│    從 "update" stream 讀取車票信息                        │
│    從 Redis Cache 獲取用戶數據、商店信息                  │
│    豐富數據 → 推送到 Redis Stream "enricher"             │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 4. Reserver (預訂器)                                     │
│    從 "enricher" stream 讀取完整數據                      │
│    調用 KTMB API 預訂車票                                 │
│    預訂成功 → 加密數據 → 推送到 Redis Stream "reserver"   │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 5. Buyer (購買器)                                        │
│    從 "reserver" stream 讀取預訂數據                       │
│    調用 KTMB API 完成購票                                 │
│    下載票據 PDF                                           │
│    調用 Zinc API 上傳票據並完成訂單                       │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 6. Terminator (終止器)                                   │
│    清理資源，終止相關進程                                 │
└─────────────────────────────────────────────────────────┘
```

## 三、技術架構

### 3.1 數據流

```
┌─────────────┐
│  Zinc API   │
└──────┬──────┘
       │
       │ HTTP API 調用
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│                    Redis Streams                        │
│                                                          │
│  cdc ──────→ update ──────→ enricher ──────→ reserver  │
│   ↑                                                      │
│   │                                                      │
│   └─────────────────────────────────────────────────────┘
│                                                          │
│  每個組件從上一個 stream 讀取，推送到下一個 stream        │
└─────────────────────────────────────────────────────────┘
```

### 3.2 Redis 使用

項目使用**三個 Redis 實例**：

1. **MAIN Cache** (`zinc-maincache`)
   - 連接 Zinc 服務的 Redis
   - 存儲用戶數據、商店信息等

2. **LIVE Cache** (`tin-livecache-master`)
   - 實時數據緩存
   - 存儲當前處理的訂單狀態

3. **STREAM Cache** (`zinc-streamcache-master`)
   - Stream 專用緩存
   - 存儲組件間的消息流

### 3.3 組件通信方式

- **異步通信**: 使用 Redis Streams（類似消息隊列）
- **同步通信**: 使用 HTTP API（Zinc API、KTMB API）
- **狀態管理**: 使用 Redis Cache

## 四、關鍵文件說明

### 4.1 入口文件

- `main.go` - 應用入口，定義所有 CLI 命令
- `cmds/*.go` - 每個組件的啟動邏輯

### 4.2 業務邏輯

- `lib/cdc/` - 監聽訂單變化
- `lib/poller/` - 輪詢車票可用性
- `lib/enricher/` - 豐富數據
- `lib/reserver/` - 預訂車票
- `lib/buyer/` - 購買車票
- `lib/terminator/` - 清理資源

### 4.3 外部集成

- `lib/zinc/` - Zinc API 客戶端（自動生成的 OpenAPI SDK）
- `lib/ktmb/` - KTMB API 客戶端
- `lib/auth/` - 身份驗證（Descope）

### 4.4 配置

- `config/app/settings.yaml` - 主配置文件
- `config/app/settings.{landscape}.yaml` - 環境配置

## 五、如何運行

### 5.1 開發模式

```bash
# 設置環境
task setup

# 運行單個組件
task dev -- cdc
task dev -- poller
task dev -- enricher
task dev -- reserver
task dev -- buyer

# 監視模式（自動重載）
task dev:watch -- cdc
```

### 5.2 生產模式

```bash
# 構建
task build

# 運行
./bin/nitroso-tin cdc
./bin/nitroso-tin poller
# ... 等等
```

## 六、常見問題

### Q1: 為什麼需要 Zinc？

A: Zinc 提供訂單管理和數據存儲功能。Tin 只負責執行訂票，不管理訂單數據。

### Q2: 可以只用部分組件嗎？

A: 可以，但需要理解依賴關係：
- CDC → Poller → Enricher → Reserver → Buyer
- 每個組件依賴上一個組件的輸出

### Q3: 如何自定義訂票邏輯？

A: 主要修改：
- `lib/reserver/` - 預訂邏輯
- `lib/buyer/` - 購買邏輯
- `lib/ktmb/` - KTMB API 調用

### Q4: 如何調試？

A: 
1. 查看日誌（Zerolog 結構化日誌）
2. 查看 OpenTelemetry 追蹤
3. 檢查 Redis Streams 中的消息
4. 使用 `task dev:watch` 進行開發

## 七、快速開始檢查清單

- [ ] 設置環境變量（`ENCRYPTION_KEY`, `LANDSCAPE`）
- [ ] 配置 Redis 連接（MAIN, LIVE, STREAM）
- [ ] 確保 Zinc API 服務運行
- [ ] 配置 Zinc API 地址（`buyer.host:port`, `cdc.host:port`）
- [ ] 配置 Descope 認證（`auth.descope`）
- [ ] 配置 KTMB API（如果需要）
- [ ] 設置業務配置（聯繫電話、郵箱等）
- [ ] 測試單個組件

## 八、架構優勢

1. **解耦**: 組件間通過 Redis Streams 異步通信，互不依賴
2. **可擴展**: 每個組件可以獨立擴展
3. **可靠性**: 包含重試機制和錯誤處理
4. **可觀測性**: 完整的 OpenTelemetry 集成
